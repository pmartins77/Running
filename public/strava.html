<script>
    document.addEventListener("DOMContentLoaded", () => {
        checkStravaConnection();
        loadActivities();
    });

    async function checkStravaConnection() {
        const token = localStorage.getItem("jwt");
        if (!token) {
            alert("Vous devez √™tre connect√© !");
            window.location.href = "login.html";
            return;
        }

        try {
            const response = await fetch("/api/user/profile", {
                method: "GET",
                headers: { "Authorization": `Bearer ${token}` }
            });

            if (!response.ok) throw new Error("Impossible de r√©cup√©rer les informations utilisateur.");

            const user = await response.json();
            const button = document.getElementById("stravaConnectButton");

            if (user.strava_id) {
                button.textContent = "‚ùå D√©connecter Strava";
                button.onclick = disconnectStrava;
            } else {
                button.textContent = "üîó Connecter Strava";
                button.onclick = connectStrava;
            }
        } catch (error) {
            console.error("‚ùå Erreur v√©rification Strava :", error);
        }
    }

    async function connectStrava() {
        const token = localStorage.getItem("jwt");
        if (!token) {
            alert("Vous devez √™tre connect√© !");
            window.location.href = "login.html";
            return;
        }

        try {
            const response = await fetch("/api/strava/connect", {
                method: "GET",
                headers: { "Authorization": `Bearer ${token}` }
            });

            if (!response.ok) throw new Error("Erreur lors de la connexion √† Strava");

            const data = await response.json();
            if (data.auth_url) {
                window.location.href = data.auth_url;
            }
        } catch (error) {
            console.error("‚ùå Erreur connexion Strava :", error);
            alert("Impossible de se connecter √† Strava.");
        }
    }

    async function disconnectStrava() {
        const token = localStorage.getItem("jwt");
        if (!token) return;

        try {
            const response = await fetch("/api/strava/disconnect", {
                method: "POST",
                headers: { "Authorization": `Bearer ${token}` }
            });

            if (!response.ok) throw new Error("Erreur lors de la d√©connexion de Strava");

            alert("Compte Strava d√©connect√© !");
            checkStravaConnection();
        } catch (error) {
            console.error("‚ùå Erreur d√©connexion Strava :", error);
            alert("Impossible de d√©connecter Strava.");
        }
    }

    async function refreshStravaActivities() {
        const token = localStorage.getItem("jwt");
        if (!token) {
            alert("Vous devez √™tre connect√© !");
            window.location.href = "login.html";
            return;
        }

        try {
            const response = await fetch("/api/strava/import", {
                method: "POST",
                headers: { "Authorization": `Bearer ${token}` }
            });

            if (!response.ok) throw new Error("Erreur lors de l'importation des activit√©s Strava");

            alert("Importation Strava r√©ussie !");
            window.location.reload();
        } catch (error) {
            console.error("‚ùå Erreur importation Strava :", error);
            alert("Erreur lors de l'importation des activit√©s Strava.");
        }
    }
</script>
