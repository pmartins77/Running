<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä Mes Activit√©s Strava</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <h1>üìä Mes Activit√©s Strava</h1>

    <button onclick="window.location.href='index.html'">‚¨ÖÔ∏è Retour</button>
    <button id="stravaConnectButton" onclick="connectStrava()">üîó Connecter Strava</button>
    <button onclick="refreshStravaActivities()">üîÑ Rafra√Æchir</button>

    <table>
        <thead>
            <tr>
                <th>üìÖ Date</th>
                <th>üèÉ Nom</th>
                <th>üìè Distance (km)</th>
                <th>‚è±Ô∏è Dur√©e (min)</th>
                <th>üöÄ Vitesse Moy. (km/h)</th>
                <th>‚ù§Ô∏è FC Moy.</th>
                <th>üî• FC Max.</th>
                <th>‚õ∞Ô∏è D+ (m)</th>
            </tr>
        </thead>
        <tbody id="activities"></tbody>
    </table>

    <script>
    document.addEventListener("DOMContentLoaded", () => {
        checkStravaConnection();
        loadActivities();
    });

    // ‚úÖ V√©rifier la connexion Strava et mettre √† jour le bouton
    async function checkStravaConnection() {
        const token = localStorage.getItem("jwt");
        if (!token) {
            alert("Vous devez √™tre connect√© !");
            window.location.href = "login.html";
            return;
        }

        try {
            const response = await fetch("/api/user/profile", {
                method: "GET",
                headers: { "Authorization": `Bearer ${token}` }
            });

            if (!response.ok) throw new Error("Impossible de r√©cup√©rer les informations utilisateur.");

            const user = await response.json();
            const button = document.getElementById("stravaConnectButton");

            if (user.strava_id) {
                button.textContent = "‚ùå D√©connecter Strava";
                button.onclick = disconnectStrava;
            } else {
                button.textContent = "üîó Connecter Strava";
                button.onclick = connectStrava;
            }
        } catch (error) {
            console.error("‚ùå Erreur v√©rification Strava :", error);
        }
    }

    // ‚úÖ Connexion √† Strava (Redirection vers la page d'autorisation)
    async function connectStrava() {
        const token = localStorage.getItem("jwt");
        if (!token) {
            alert("Vous devez √™tre connect√© !");
            window.location.href = "login.html";
            return;
        }

        try {
            const response = await fetch("/api/strava/connect", {
                method: "GET",
                headers: { "Authorization": `Bearer ${token}` }
            });

            if (!response.ok) throw new Error("Erreur lors de la connexion √† Strava");

            const data = await response.json();
            if (data.auth_url) {
                window.location.href = data.auth_url; // Redirection vers Strava
            }
        } catch (error) {
            console.error("‚ùå Erreur connexion Strava :", error);
            alert("Impossible de se connecter √† Strava.");
        }
    }

    // ‚úÖ D√©connexion de Strava
    async function disconnectStrava() {
        const token = localStorage.getItem("jwt");
        if (!token) return;

        try {
            const response = await fetch("/api/strava/disconnect", {
                method: "POST",
                headers: { "Authorization": `Bearer ${token}` }
            });

            if (!response.ok) throw new Error("Erreur lors de la d√©connexion de Strava");

            alert("Compte Strava d√©connect√© !");
            checkStravaConnection();
        } catch (error) {
            console.error("‚ùå Erreur d√©connexion Strava :", error);
            alert("Impossible de d√©connecter Strava.");
        }
    }

    // ‚úÖ Rafra√Æchir les activit√©s Strava
    async function refreshStravaActivities() {
        const token = localStorage.getItem("jwt");
        if (!token) {
            alert("Vous devez √™tre connect√© !");
            window.location.href = "login.html";
            return;
        }

        try {
            const response = await fetch("/api/strava/import", {
                method: "POST",
                headers: { "Authorization": `Bearer ${token}` }
            });

            if (!response.ok) throw new Error("Erreur lors de l'importation des activit√©s Strava");

            alert("Importation Strava r√©ussie !");
            loadActivities();
        } catch (error) {
            console.error("‚ùå Erreur importation Strava :", error);
            alert("Erreur lors de l'importation des activit√©s Strava.");
        }
    }

    // ‚úÖ Charger les activit√©s Strava stock√©es en base
    async function loadActivities() {
        const token = localStorage.getItem("jwt");

        if (!token) {
            alert("Vous devez √™tre connect√© !");
            window.location.href = "login.html";
            return;
        }

        try {
            const response = await fetch("/api/strava/list", {
                method: "GET",
                headers: { "Authorization": `Bearer ${token}` }
            });

            if (!response.ok) {
                throw new Error(`Erreur API : ${response.statusText}`);
            }

            const activities = await response.json();

            if (!Array.isArray(activities)) {
                throw new Error("Donn√©es invalides re√ßues du serveur");
            }

            displayActivities(activities);
        } catch (error) {
            console.error("‚ùå Erreur lors du chargement des activit√©s :", error);
            alert("Erreur lors du chargement des activit√©s Strava.");
        }
    }

    // ‚úÖ Afficher les activit√©s dans le tableau
    function displayActivities(activities) {
        const activitiesTable = document.getElementById("activities");
        activitiesTable.innerHTML = ""; // Nettoyage avant affichage

        if (activities.length === 0) {
            activitiesTable.innerHTML = "<tr><td colspan='8'>Aucune activit√© trouv√©e.</td></tr>";
            return;
        }

        activities.forEach(activity => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${new Date(activity.date).toLocaleDateString()}</td>
                <td>${activity.name}</td>
                <td>${parseFloat(activity.distance).toFixed(2)}</td>
                <td>${parseFloat(activity.moving_time).toFixed(0)} min</td>
                <td>${parseFloat(activity.average_speed).toFixed(2)}</td>
                <td>${activity.average_heartrate ? activity.average_heartrate.toFixed(0) + " bpm" : "N/A"}</td>
                <td>${activity.max_heartrate ? activity.max_heartrate.toFixed(0) + " bpm" : "N/A"}</td>
                <td>${activity.total_elevation_gain ? activity.total_elevation_gain.toFixed(0) + " m" : "N/A"}</td>
            `;
            activitiesTable.appendChild(row);
        });
    }
    </script>

</body>
</html>
